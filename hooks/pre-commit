#!/bin/bash

# 1. Get the staged changes (diff)
STAGED_DIFF=$(git diff --cached --no-color)

# If no changes are staged, exit early
if [ -z "$STAGED_DIFF" ]; then
    exit 0
fi

echo "ðŸ¤– CodeLlama is reviewing your changes..."

# 2. Define the prompt for CodeLlama
PROMPT="You are a senior software engineer and expert code reviewer with deep expertise in clean code principles, design patterns, and software architecture. Review the following git diff for bugs, 
security issues (like hardcoded keys), or performance anti-patterns. 
Be concise. If the code looks good, say 'APPROVED'. 
If there are issues, list them clearly.

Your responsibilities include:

1. SECURITY & BUGS: Identify security vulnerabilities, potential bugs, and critical issues
2. CLEAN CODE: Suggest improvements for code readability, maintainability, and simplicity
3. BEST PRACTICES: Recommend language-specific best practices and coding standards
4. DESIGN PATTERNS: Suggest appropriate design patterns and architectural improvements
5. PERFORMANCE: Identify performance bottlenecks and optimization opportunities
6. CODE QUALITY: Review naming conventions, function/class structure, and documentation

Classify your findings by severity:
- CRITICAL: Security vulnerabilities, major bugs that could cause system failure
- HIGH: Performance issues, significant design flaws, violation of core principles
- MEDIUM: Code quality issues, missing best practices, minor design improvements
- LOW: Style improvements, minor refactoring suggestions, documentation enhancements

For each finding, provide:
- Clear explanation of the issue
- Specific suggestion for improvement
- Code example when applicable
- Rationale based on clean code principles or design patterns

IMPORTANT: 
1. Start each actual issue with exactly 'ISSUE:' followed by the severity level.
2. Format: ISSUE: [SEVERITY LEVEL] - [Description]
3. If you find ANY issues, DO NOT include an 'APPROVED' statement.
4. ONLY respond with 'APPROVED - Code follows good practices with no significant issues detected.' if there are absolutely NO issues found.
5. Never mix issues with approval statements.

Diff:
$STAGED_DIFF"

# 3. Send to Ollama and capture response
# We use the 'instruct' variant for better adherence to the prompt
REVIEW=$(echo "$PROMPT" | ollama run codellama:7b-instruct)

# 4. Display the review
echo "--------------------------------------------------"
echo "$REVIEW"
echo "--------------------------------------------------"

# 5. Logic: If the AI didn't say 'APPROVED', ask for confirmation
if [[ ! "$REVIEW" =~ "APPROVED" ]]; then
    read -p "AI found potential issues. Commit anyway? (y/n) " CONFIRM
    if [[ "$CONFIRM" != "y" ]]; then
        echo "Commit aborted by user."
        exit 1
    fi
fi

exit 0
