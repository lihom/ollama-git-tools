#!/bin/bash

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# 1. Only run if the user hasn't provided a message via -m or -f
# This avoids overwriting intentional messages or merge/squash messages.
if [ -z "$COMMIT_SOURCE" ]; then

    # 2. Get the staged changes
    DIFF=$(git diff --cached --no-color)

    # If no changes are staged, just exit
    if [ -z "$DIFF" ]; then
        exit 0
    fi

    echo "ðŸ¦™ CodeLlama is drafting your commit message..."

    # 3. Construct the AI Prompt
    PROMPT="Context: You are a helpful assistant writing a git commit message.
Instructions:
- Use the 'Conventional Commits' format (e.g., feat: description, fix: description).
- Be concise (one line if possible).
- Do not include any preamble like 'Here is your message'.
- Base the message on this diff:

$DIFF"

    # 4. Generate message using Ollama
    # We use a smaller/faster model here since commit messages should be quick
    AI_MSG=$(echo "$PROMPT" | ollama run codellama:7b-instruct)

    # 5. Prepend the AI message to the commit file
    # We leave a comment so the user knows it was AI-generated
    echo "$AI_MSG" > "$COMMIT_MSG_FILE"
    echo "" >> "$COMMIT_MSG_FILE"
    echo "# --- AI Generated Message Above ---" >> "$COMMIT_MSG_FILE"
fi