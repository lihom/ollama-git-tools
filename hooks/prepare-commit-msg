#!/bin/bash

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# 1. Only run if the user hasn't provided a message via -m or -f
# This avoids overwriting intentional messages or merge/squash messages.
if [ -z "$COMMIT_SOURCE" ]; then

    # 2. Get the staged changes
    DIFF=$(git diff --cached ":(exclude)package-lock.json")

    # If no changes are staged, just exit
    if [ -z "$DIFF" ]; then
        exit 0
    fi

    echo "ðŸ¤– gemma3 is drafting your commit message..."

    # 3. Construct the AI Prompt
    PROMPT="Write a git commit message based on this diff:
1. Format: Use 'Conventional Commits' (type: description).
2. Type Definitions:
   - feat: New feature implementation
   - fix: Bug fix
   - docs: Documentation changes
   - style: Formatting (no logic change)
   - refactor: Code restructuring (no fix/feature)
   - perf: Performance improvements
   - test: Adding/correcting tests
   - chore: Build process or auxiliary tool changes
3. Constraints: One-liner, direct output, no preamble.

Git Diff:
$DIFF"

    # 4. Generate message using Ollama
    # We use a smaller/faster model here since commit messages should be quick
    AI_MSG=$(echo "$PROMPT" | ollama run gemma3)

    # 5. Prepend the AI message to the commit file
    # We leave a comment so the user knows it was AI-generated
    echo "$AI_MSG" > "$COMMIT_MSG_FILE"
    echo "" >> "$COMMIT_MSG_FILE"
    echo "# --- AI Generated Message Above ---" >> "$COMMIT_MSG_FILE"
fi
